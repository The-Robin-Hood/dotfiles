#!/usr/bin/env bash

WINDOW_PATTERN="$1"
# Default to uwsm-app, but allow override
LAUNCH_COMMAND="${2:-"uwsm-app -- $WINDOW_PATTERN"}"

# 1. Removed .title check to avoid matching terminal command history
# 2. Added .initialClass check (helps with some electron apps)
# 3. Added sort_by(.focusHistoryID) to ensure we grab the most recently used instance
WINDOW_ADDRESS=$(hyprctl clients -j | jq -r --arg p "$WINDOW_PATTERN" '
  map(select(
    (.class | test("\\b" + $p + "\\b"; "i")) or 
    (.initialClass | test("\\b" + $p + "\\b"; "i")) or 
    (.class | contains($p)) or 
    (.class | test($p; "i"))
  )) 
  | sort_by(.focusHistoryID) 
  | reverse 
  | .[0].address // empty'
)

if [[ -n $WINDOW_ADDRESS && $WINDOW_ADDRESS != "null" ]]; then
  hyprctl dispatch focuswindow "address:$WINDOW_ADDRESS"
else
  # Use eval to handle arguments in LAUNCH_COMMAND correctly
  eval exec setsid $LAUNCH_COMMAND &>/dev/null &
fi